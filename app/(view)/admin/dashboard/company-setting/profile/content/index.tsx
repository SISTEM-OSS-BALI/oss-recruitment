"use client";

import { useEffect } from "react";
import type { ReactNode } from "react";
import {
  Button,
  Card,
  Col,
  Divider,
  Form,
  Input,
  Row,
  Select,
  Skeleton,
  Space,
  Typography,
  message,
} from "antd";

import SupaImageUploader from "@/app/utils/image-uploader";
import { useAuth } from "@/app/utils/useAuth";
import {
  useProfileCompanyByUserId,
  useProfileCompanys,
  useProfileCompany,
} from "@/app/hooks/profile-company";
import {
  ProfileCompanyDataModel,
  ProfileCompanyPayloadCreateModel,
} from "@/app/models/profile-company";

type ProfileCompanyFormValues = Pick<
  ProfileCompanyDataModel,
  | "company_name"
  | "description"
  | "total_employee"
  | "industry"
  | "website_url"
  | "instagram_url"
  | "facebook_url"
  | "linkedin_url"
  | "twitter_url"
  | "logo_url"
>;

const EMPLOYEE_OPTIONS = [
  { label: "1 - 10 employees", value: 10 },
  { label: "11 - 50 employees", value: 50 },
  { label: "51 - 200 employees", value: 200 },
  { label: "201 - 500 employees", value: 500 },
  { label: "500+ employees", value: 1000 },
] as const;

const INDUSTRY_OPTIONS = [
  "Education Management",
  "Information Technology",
  "Hospitality",
  "Finance",
  "Media & Entertainment",
  "Retail",
  "Consulting",
  "Manufacturing",
] as const;

const mapProfileToFormValues = (
  profile: ProfileCompanyDataModel
): ProfileCompanyFormValues => ({
  company_name: profile.company_name,
  description: profile.description,
  total_employee: profile.total_employee,
  industry: profile.industry,
  website_url: profile.website_url ?? "",
  instagram_url: profile.instagram_url ?? "",
  facebook_url: profile.facebook_url ?? "",
  linkedin_url: profile.linkedin_url ?? "",
  twitter_url: profile.twitter_url ?? "",
  logo_url: profile.logo_url ?? "",
});

const normalizeFormValues = (
  values: ProfileCompanyFormValues
): ProfileCompanyFormValues => ({
  company_name: values.company_name.trim(),
  description: values.description.trim(),
  total_employee: values.total_employee,
  industry: values.industry,
  website_url: values.website_url?.trim() ?? "",
  instagram_url: values.instagram_url?.trim() ?? "",
  facebook_url: values.facebook_url?.trim() ?? "",
  linkedin_url: values.linkedin_url?.trim() ?? "",
  twitter_url: values.twitter_url?.trim() ?? "",
  logo_url: values.logo_url?.trim() ?? "",
});

export default function CompanySettingProfileContent() {
  const { user_id } = useAuth();
  const [form] = Form.useForm<ProfileCompanyFormValues>();

  const { data, fetchLoading } = useProfileCompanyByUserId({
    id: user_id,
  });
  console.log(data);
  const { onCreate, onCreateLoading } = useProfileCompanys();
  const { onUpdate, onUpdateLoading } = useProfileCompany();

  useEffect(() => {
    if (data) {
      form.setFieldsValue(mapProfileToFormValues(data));
    }
  }, [data, form]);

  const isSubmitting = onCreateLoading || onUpdateLoading;
  const submittingLabel = data ? "Save" : "Save Profile";

  const handleFinish = async (values: ProfileCompanyFormValues) => {
    const normalizedValues = normalizeFormValues(values);

    const payload: ProfileCompanyPayloadCreateModel = {
      company_name: normalizedValues.company_name,
      description: normalizedValues.description,
      total_employee: normalizedValues.total_employee,
      user_id: user_id!,
      industry: normalizedValues.industry,
      website_url: normalizedValues.website_url || null,
      instagram_url: normalizedValues.instagram_url || null,
      facebook_url: normalizedValues.facebook_url || null,
      linkedin_url: normalizedValues.linkedin_url || null,
      twitter_url: normalizedValues.twitter_url || null,
      logo_url: normalizedValues.logo_url || null,
    };

    try {
      if (data?.id) {
        await onUpdate({ id: data.id, payload });
      } else {
        await onCreate(payload);
      }
      form.setFieldsValue(normalizedValues);
    } catch (error) {
      const errMessage =
        error instanceof Error
          ? error.message
          : "Error submitting company profile data.";
      message.error(errMessage);
    }
  };

  const renderForm = () => (
    <Form
      layout="vertical"
      form={form}
      onFinish={handleFinish}
      requiredMark={false}
      style={{ marginTop: 16 }}
    >
      <Row gutter={[24, 24]}>
        <Col xs={24} md={10}>
          <Form.Item
            label={
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <Typography.Text strong>Company Logo</Typography.Text>
                <Typography.Text style={{ color: "#d4380d" }}>
                  *
                </Typography.Text>
              </div>
            }
            name="logo_url"
            rules={[{ required: true, message: "Company logo is required" }]}
          >
            <SupaImageUploader
              bucket="web-oss-recruitment"
              folder="company-profile"
              accept="image/png,image/jpeg"
            />
          </Form.Item>
          <Space direction="vertical" size={0}>
            <Typography.Text type="secondary">
              Accepted formats: .jpg, .jpeg, .png
            </Typography.Text>
            <Typography.Text type="secondary">
              Recommended size: 120px x 120px
            </Typography.Text>
          </Space>
        </Col>
        <Col xs={24} md={14}>
          <Typography.Text strong style={{ color: "#d4380d" }}>
            âœ± Required
          </Typography.Text>
          <Typography.Paragraph type="secondary" style={{ marginTop: 8 }}>
            Make sure your logo is square so it appears consistent across all
            your career pages.
          </Typography.Paragraph>
        </Col>
      </Row>

      <Divider />

      <Row gutter={[24, 12]}>
        <Col span={24}>
          <Form.Item
            label="Company Name"
            name="company_name"
            rules={[{ required: true, message: "Company name is required" }]}
          >
            <Input placeholder="One Step Solution Bali" size="large" />
          </Form.Item>
        </Col>

        <Col span={24}>
          <Form.Item
            label="Description"
            name="description"
            rules={[
              { required: true, message: "Company description is required" },
            ]}
          >
            <Input.TextArea
              placeholder="What are your company's vision and mission?"
              autoSize={{ minRows: 4 }}
            />
          </Form.Item>
        </Col>
      </Row>

      <Row gutter={[24, 12]}>
        <Col xs={24} md={12}>
          <Form.Item
            label="Number of Employees"
            name="total_employee"
            rules={[
              { required: true, message: "Number of employees is required" },
            ]}
          >
            <Select
              placeholder="Select employee range"
              size="large"
              options={EMPLOYEE_OPTIONS.map((opt) => ({
                label: opt.label,
                value: opt.value,
              }))}
            />
          </Form.Item>
        </Col>
        <Col xs={24} md={12}>
          <Form.Item
            label="Industry"
            name="industry"
            rules={[{ required: true, message: "Industry is required" }]}
          >
            <Select
              placeholder="Select industry"
              size="large"
              options={INDUSTRY_OPTIONS.map((ind) => ({
                label: ind,
                value: ind,
              }))}
              showSearch
              optionFilterProp="label"
            />
          </Form.Item>
        </Col>
      </Row>

      <Row gutter={[24, 12]}>
        <Col span={24}>
          <Form.Item
            label="Company Website"
            name="website_url"
            rules={[
              {
                type: "url",
                message: "Please enter a valid website URL",
              },
            ]}
          >
            <Input
              placeholder="https://onestepsolutionbali.com/"
              size="large"
            />
          </Form.Item>
        </Col>
      </Row>

      <Divider />

      <Typography.Title level={5} style={{ marginBottom: 8 }}>
        Social Media
      </Typography.Title>
      <Typography.Paragraph type="secondary">
        Add official social media links so candidates can learn more about your
        company culture.
      </Typography.Paragraph>

      <Row gutter={[24, 12]}>
        <Col xs={24} md={12}>
          <Form.Item label="Instagram" name="instagram_url">
            <Input
              placeholder="https://instagram.com/yourcompany"
              size="large"
            />
          </Form.Item>
        </Col>
        <Col xs={24} md={12}>
          <Form.Item label="Facebook" name="facebook_url">
            <Input
              placeholder="https://facebook.com/yourcompany"
              size="large"
            />
          </Form.Item>
        </Col>
        <Col xs={24} md={12}>
          <Form.Item label="LinkedIn" name="linkedin_url">
            <Input
              placeholder="https://linkedin.com/company/yourcompany"
              size="large"
            />
          </Form.Item>
        </Col>
        <Col xs={24} md={12}>
          <Form.Item label="Twitter" name="twitter_url">
            <Input placeholder="https://twitter.com/yourcompany" size="large" />
          </Form.Item>
        </Col>
      </Row>

      <Divider />

      <div style={{ display: "flex", justifyContent: "flex-end", gap: 12 }}>
        <Button onClick={() => form.resetFields()}>Reset</Button>
        <Button
          type="primary"
          htmlType="submit"
          loading={isSubmitting}
          style={{ minWidth: 180, background: "#0052cc" }}
        >
          {submittingLabel}
        </Button>
      </div>
    </Form>
  );

  let content: ReactNode;
  if (fetchLoading && !data) {
    content = <Skeleton active paragraph={{ rows: 8 }} />;
  } else if (!user_id) {
    content = (
      <Typography.Text type="secondary">
        Please sign in to manage your company profile.
      </Typography.Text>
    );
  } else {
    content = renderForm();
  }

  return (
    <Card>
      <Typography.Title level={4} style={{ marginBottom: 0 }}>
        Company Profile
      </Typography.Title>
      <Typography.Paragraph type="secondary" style={{ marginBottom: 0 }}>
        Complete your company details so candidates can understand the culture
        and scale of your organization.
      </Typography.Paragraph>

      {content}
    </Card>
  );
}
